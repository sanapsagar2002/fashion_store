{% extends 'base.html' %}

{% block title %}Products - Fashion Store{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Hero Section for Products -->
    <div class="hero-section mb-4">
        <div class="hero-content">
            <h1 class="hero-title">Discover Amazing Fashion</h1>
            <p class="hero-subtitle">Shop the latest trends in men's, women's, and kids' fashion</p>
        </div>
    </div>

    <div class="row">
        <!-- Enhanced Filters Sidebar -->
        <div class="col-lg-3 col-md-4">
            <div class="filter-sidebar">
                <h4 class="filter-title">
                    <i class="fas fa-filter me-2"></i>Filters
                </h4>
                
                <form id="filter-form">
                    <!-- Category Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-tags me-1"></i>Category
                        </label>
                        <select class="form-select" name="category" id="category-filter">
                            <option value="">All Categories</option>
                            <option value="Men">Men's Fashion</option>
                            <option value="Women">Women's Fashion</option>
                            <option value="Kids">Kids Fashion</option>
                        </select>
                    </div>

                    <!-- Accessory Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-gem me-1"></i>Accessories
                        </label>
                        <select class="form-select" name="accessory" id="accessory-filter">
                            <option value="">All Items</option>
                            <option value="watch">Watches</option>
                            <option value="sneaker">Sneakers</option>
                        </select>
                    </div>
                    
                    <!-- Brand Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-crown me-1"></i>Brand
                        </label>
                        <select class="form-select" name="brand" id="brand-filter">
                            <option value="">All Brands</option>
                            <option value="Nike">Nike</option>
                            <option value="Adidas">Adidas</option>
                            <option value="Zara">Zara</option>
                            <option value="H&M">H&M</option>
                            <option value="Levi's">Levi's</option>
                            <option value="Gucci">Gucci</option>
                            <option value="Prada">Prada</option>
                        </select>
                    </div>
                    
                    <!-- Size Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-ruler me-1"></i>Size
                        </label>
                        <div class="row">
                            <div class="col-6">
                                        <select class="form-select" name="size" id="size-filter">
                                            <option value="">All Sizes</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                            <option value="One Size">One Size</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                            <option value="9">9</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                        </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Range Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-dollar-sign me-1"></i>Price Range
                        </label>
                        <div class="price-range">
                            <input type="number" class="form-control" placeholder="Min" name="min_price" id="min-price">
                            <span>to</span>
                            <input type="number" class="form-control" placeholder="Max" name="max_price" id="max-price">
                        </div>
                        <div class="mt-2">
                            <input type="range" class="form-range" min="0" max="1000" value="500" id="price-slider">
                            <div class="d-flex justify-content-between">
                                <small>$0</small>
                                <small>$1000+</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Color Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-palette me-1"></i>Color
                        </label>
                        <div class="color-options">
                            <div class="color-option" data-color="black" style="background: #000;"></div>
                            <div class="color-option" data-color="white" style="background: #fff; border: 1px solid #ddd;"></div>
                            <div class="color-option" data-color="red" style="background: #dc3545;"></div>
                            <div class="color-option" data-color="blue" style="background: #007bff;"></div>
                            <div class="color-option" data-color="green" style="background: #28a745;"></div>
                            <div class="color-option" data-color="yellow" style="background: #ffc107;"></div>
                            <div class="color-option" data-color="purple" style="background: #6f42c1;"></div>
                            <div class="color-option" data-color="pink" style="background: #e83e8c;"></div>
                        </div>
                        <input type="hidden" name="color" id="color-filter">
                    </div>

                    <!-- Rating Filter -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-star me-1"></i>Rating
                        </label>
                        <div class="rating-filter">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="rating" value="4" id="rating-4">
                                <label class="form-check-label" for="rating-4">
                                    <i class="fas fa-star text-warning"></i>
                                    <i class="fas fa-star text-warning"></i>
                                    <i class="fas fa-star text-warning"></i>
                                    <i class="fas fa-star text-warning"></i>
                                    <i class="far fa-star text-warning"></i>
                                    & Up
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="rating" value="3" id="rating-3">
                                <label class="form-check-label" for="rating-3">
                                    <i class="fas fa-star text-warning"></i>
                                    <i class="fas fa-star text-warning"></i>
                                    <i class="fas fa-star text-warning"></i>
                                    <i class="far fa-star text-warning"></i>
                                    <i class="far fa-star text-warning"></i>
                                    & Up
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-search me-1"></i>Apply Filters
                    </button>
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear All
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Products Grid -->
        <div class="col-lg-9 col-md-8">
            <!-- Search and Sort Bar -->
            <div class="search-container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="search-input" placeholder="Search products, brands, categories..." id="search-input">
                            <button class="search-btn" type="button" onclick="searchProducts()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="sort-container">
                            <label class="form-label me-2">Sort by:</label>
                            <select class="sort-select" id="sort-select">
                                <option value="-created_at">Newest First</option>
                                <option value="price">Price: Low to High</option>
                                <option value="-price">Price: High to Low</option>
                                <option value="name">Name: A to Z</option>
                                <option value="-name">Name: Z to A</option>
                                <option value="-average_rating">Highest Rated</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Info -->
            <div class="results-info mb-3">
                <span id="results-count">Loading products...</span>
                <div class="view-options float-end">
                    <button class="btn btn-sm btn-outline-secondary active" id="grid-view">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="list-view">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
            
            <!-- Global Coupon Code 
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-6">
                            <label class="form-label mb-1"><i class="fas fa-tag me-1"></i>Have a coupon? Enter it here</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="global-coupon-code" placeholder="e.g. WELCOME">
                                <button class="btn btn-outline-primary" type="button" onclick="applyGlobalCoupon()">Apply</button>
                            </div>
                            <small id="global-coupon-status" class="text-muted"></small>
                        </div>
                        <div class="col-md-6">
                            <div id="coupon-list" class="small text-muted">
                                Tip: Try <span class="badge bg-success">WELCOME</span> for 10% off
                            </div>
                        </div>
                    </div>
                </div>
            </div>
           -->
            <!-- Products Grid -->
            <div class="row" id="products-grid">
                <!-- Products will be loaded here -->
            </div>

            <!-- Loading Spinner -->
            <div class="text-center py-5" id="loading-spinner" style="display: none;">
                <div class="loading"></div>
                <p class="mt-2">Loading products...</p>
            </div>
            
            <!-- Pagination -->
            <nav aria-label="Products pagination" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be loaded here -->
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentFilters = {};
    let currentView = 'grid';

    // Enhanced product loading with better error handling
    async function loadProducts(page = 1) {
        try {
            showLoading(true);
            const params = new URLSearchParams({ page: page });

            // Apply all filters
            if (currentFilters.category) params.append('gender', currentFilters.category);
            if (currentFilters.accessory) params.append('accessory_type', currentFilters.accessory);
            if (currentFilters.brand) params.append('brand', currentFilters.brand);
            if (currentFilters.size) params.append('size', currentFilters.size);
            if (currentFilters.color) params.append('color', currentFilters.color);
            if (currentFilters.min_price) params.append('price__gte', currentFilters.min_price);
            if (currentFilters.max_price) params.append('price__lte', currentFilters.max_price);
            if (currentFilters.rating) params.append('average_rating__gte', currentFilters.rating);
            if (currentFilters.ordering) params.append('ordering', currentFilters.ordering);
            if (currentFilters.q) params.append('q', currentFilters.q);
            
            const response = await fetch(`/api/products/?${params}`);
            const data = await response.json();
            
            displayProducts(data.results || data);
            updatePagination(data);
            updateResultsCount(data);
            currentPage = page;
        } catch (error) {
            console.error('Error loading products:', error);
            showAlert('Error loading products. Please try again.', 'danger');
        } finally {
            showLoading(false);
        }
    }

    function showLoading(show) {
        const spinner = document.getElementById('loading-spinner');
        const grid = document.getElementById('products-grid');
        if (show) {
            spinner.style.display = 'block';
            grid.style.opacity = '0.5';
        } else {
            spinner.style.display = 'none';
            grid.style.opacity = '1';
        }
    }

    function displayProducts(products) {
        const container = document.getElementById('products-grid');
        container.innerHTML = '';
        
        if (products.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4>No products found</h4>
                    <p class="text-muted">Try adjusting your filters or search terms</p>
                    <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
                </div>
            `;
            return;
        }
        
        products.forEach(product => {
            const productCard = createProductCard(product);
            container.appendChild(productCard);
        });
    }

    function createProductCard(product) {
        const col = document.createElement('div');
        col.className = currentView === 'grid' ? 'col-lg-4 col-md-6 mb-4' : 'col-12 mb-4';
        
        const badges = [];
        if (product.discount_percentage > 0) {
            badges.push(`<span class="product-badge discount-badge">-${product.discount_percentage}%</span>`);
        }
        if (product.is_featured) {
            badges.push(`<span class="product-badge featured-badge">Featured</span>`);
        }
        /*
        // Ensure we always show a single reliable image
        const imageSrc = product.primary_image || '/media/products/default.jpg';
        col.innerHTML = `
            <div class="card product-card h-100 fade-in">
                ${badges.join('')}
                <div class="position-relative">
                    <img src="${imageSrc}" loading="lazy"
                         class="card-img-top" alt="${product.name}"
                         onerror="this.src='https://via.placeholder.com/300x300'">
                    <div class="product-overlay">
                        <button class="btn btn-primary btn-sm" onclick="quickView(${product.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <h6 class="product-title">${product.name}</h6>
                    <p class="product-category">${product.category_name || 'Fashion'}</p>
                    
                    <div class="product-rating">
                        <div class="stars">${generateStars(product.average_rating || 0)}</div>
                        <span class="rating-count">(${product.total_reviews || 0})</span>
                    </div>
                    
                    <div class="product-price">
                        <span class="current-price">$${product.price}</span>
                        ${product.original_price && product.original_price > product.price ? 
                            `<span class="original-price">$${product.original_price}</span>` : ''}
                        ${product.discount_percentage > 0 ? 
                            `<span class="discount-percentage">-${product.discount_percentage}%</span>` : ''}
                    </div>
                    <div class="product-actions">
                     <button class="btn btn-outline-primary btn-sm flex-fill" onclick="viewProduct(${product.id})">
                            <i class="fas fa-eye me-1"></i>View
                        </button> 
                        <button class="btn btn-primary btn-sm" onclick="showVariantModal(${product.id})">
                            <i class="fas fa-cart-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        return col;
    }
*/

     // Ensure we always show a single reliable image
        const imageSrc = product.primary_image || '/media/products/default.jpg';
        col.innerHTML = `
            <div class="card product-card h-100 fade-in">
                ${badges.join('')}
                <div class="position-relative">
                    <img src="${imageSrc}" loading="lazy"
                         class="card-img-top" alt="${product.name}"
                         onerror="this.src='https://via.placeholder.com/300x300'">
                    <div class="product-overlay">
                        <button class="btn btn-primary btn-sm" onclick="quickView(${product.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <h6 class="product-title">${product.name}</h6>
                    <p class="product-category">${product.category_name || 'Fashion'}</p>
                    <div class="product-price">
                        <span class="current-price">$${product.price}</span>
                        ${product.original_price && product.original_price > product.price ? 
                            `<span class="original-price">$${product.original_price}</span>` : ''}
                        ${product.discount_percentage > 0 ? 
                            `<span class="discount-percentage">-${product.discount_percentage}%</span>` : ''}
                    </div>
                    <div class="product-actions">
                          <button class="btn btn-outline-primary btn-sm flex-fill" onclick="viewProduct(${product.id})">
                            <i class="fas fa-eye me-1"></i>View
                        </button> 
                    
                    </div>
                </div>
            </div>
        `;
        
        return col;
    }

    
    function generateStars(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 !== 0;
        let stars = '';
        
        for (let i = 0; i < fullStars; i++) {
            stars += '<i class="fas fa-star text-warning"></i>';
        }
        
        if (hasHalfStar) {
            stars += '<i class="fas fa-star-half-alt text-warning"></i>';
        }
        
        const emptyStars = 5 - Math.ceil(rating);
        for (let i = 0; i < emptyStars; i++) {
            stars += '<i class="far fa-star text-warning"></i>';
        }
        
        return stars;
    }

    function updateResultsCount(data) {
        const count = data.count || (data.results ? data.results.length : 0);
        document.getElementById('results-count').textContent = `${count} products found`;
    }

    function showVariantModal(productId) {
        if (!authToken) {
            showAlert('Please login to add items to cart', 'warning');
            window.location.href = '/login/';
            return;
        }
        
        // For now, add the first available variant
        // In a real implementation, show a modal to select size/color
        addToCart(productId);
    }

    function quickView(productId) {
        window.location.href = `/products/${productId}/`;
    }


    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (data.previous) {
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item';
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);
        }
        
        if (data.next) {
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item';
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }
    }

    function viewProduct(productId) {
        window.location.href = `/products/${productId}/`;
    }

    function addToCart(productId) {
        if (!authToken) {
            showAlert('Please login to add items to cart', 'warning');
            window.location.href = '/login/';
            return;
        }
        
        // Simplified - add first variant
        fetch(`/api/products/${productId}/variants/`)
            .then(response => response.json())
            .then(variants => {
                if (variants.length > 0) {
                    const variantId = variants[0].id;
                    return apiRequest('/api/cart/add/', {
                        method: 'POST',
                        body: JSON.stringify({
                            product_variant_id: variantId,
                            quantity: 1
                        })
                    });
                }
            })
            .then(response => {
                if (response && response.ok) {
                    showAlert('Item added to cart!', 'success');
                    updateCartBadge();
                } else {
                    showAlert('Failed to add item to cart', 'danger');
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                showAlert('Error adding item to cart', 'danger');
            });
    }

    function searchProducts() {
        const query = document.getElementById('search-input').value;
        currentFilters.q = query;
        loadProducts(1);
    }

    function clearFilters() {
        document.getElementById('filter-form').reset();
        document.getElementById('color-filter').value = '';
        document.querySelectorAll('.color-option').forEach(option => {
            option.classList.remove('selected');
        });
        currentFilters = {};
        loadProducts(1);
    }

    // Event listeners
    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        currentFilters = Object.fromEntries(formData.entries());
        // Remove empty values
        Object.keys(currentFilters).forEach(key => {
            if (!currentFilters[key]) delete currentFilters[key];
        });
        loadProducts(1);
    });

    document.getElementById('sort-select').addEventListener('change', function() {
        currentFilters.ordering = this.value;
        loadProducts(1);
    });

    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchProducts();
        }
    });

    // Color selection
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('color-filter').value = this.dataset.color;
        });
    });

    // Price slider
    document.getElementById('price-slider').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('max-price').value = value;
    });

    // View toggle
    document.getElementById('grid-view').addEventListener('click', function() {
        currentView = 'grid';
        this.classList.add('active');
        document.getElementById('list-view').classList.remove('active');
        loadProducts(currentPage);
    });

    document.getElementById('list-view').addEventListener('click', function() {
        currentView = 'list';
        this.classList.add('active');
        document.getElementById('grid-view').classList.remove('active');
        loadProducts(currentPage);
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Check URL parameters for initial filters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('category')) {
            document.getElementById('category-filter').value = urlParams.get('category');
            currentFilters.category = urlParams.get('category');
        }
        if (urlParams.get('accessory')) {
            document.getElementById('accessory-filter').value = urlParams.get('accessory');
            currentFilters.accessory = urlParams.get('accessory');
        }
        
        loadProducts();
    });

    async function applyGlobalCoupon() {
        const input = document.getElementById('global-coupon-code');
        const status = document.getElementById('global-coupon-status');
        const code = (input.value || '').trim();
        if (!authToken) {
            showAlert('Please login to apply coupon', 'warning');
            window.location.href = '/login/';
            return;
        }
        if (!code) {
            status.textContent = 'Enter a coupon code';
            return;
        }
        status.textContent = 'Applying...';
        try {
            const resp = await apiRequest('/api/cart/apply-discount/', {
                method: 'POST',
                body: JSON.stringify({ code })
            });
            if (resp.ok) {
                const data = await resp.json();
                status.textContent = `Applied! You saved $${(data.discount_amount || 0).toFixed ? (data.discount_amount).toFixed(2) : data.discount_amount}`;
                status.className = 'text-success';
                updateCartBadge();
            } else {
                const err = await resp.json();
                status.textContent = err.error || 'Invalid or expired code';
                status.className = 'text-danger';
            }
        } catch (e) {
            status.textContent = 'Error applying coupon';
            status.className = 'text-danger';
        }
    }
</script>

<style>
/* Additional styles for enhanced products page */
.color-options {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.color-option {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.color-option:hover {
    transform: scale(1.1);
    border-color: var(--primary-color);
}

.color-option.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.3);
}

.product-overlay {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.product-card:hover .product-overlay {
    opacity: 1;
}

.results-info {
    background: var(--white);
    padding: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
}

.view-options .btn {
    margin-left: 0.25rem;
}

.view-options .btn.active {
    background: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
}

/* Make the filters sidebar scrollable */
.filter-sidebar {
    max-height: 85vh; /* Adjust height as needed */
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 8px; /* space for scrollbar */
    scrollbar-width: thin; /* Firefox */
    scrollbar-color: #ccc #f8f9fa;
}

/* For WebKit browsers (Chrome, Edge, Safari) */
.filter-sidebar::-webkit-scrollbar {
    width: 8px;
}

.filter-sidebar::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 10px;
}

.filter-sidebar::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 10px;
}

.filter-sidebar::-webkit-scrollbar-thumb:hover {
    background-color: #999;
}

</style>
{% endblock %}
